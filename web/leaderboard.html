<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>LegacyCodeBench | Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/styles.css">
  <script defer src="leaderboard.js"></script>
</head>

<body>
  <header>
    <div class="container"
      style="display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.25rem 1rem;">
      <div class="logo">LegacyCodeBench</div>
      <nav aria-label="Primary">
        <a href="index.html">Overview</a>
        <a href="leaderboard.html" class="active">Leaderboard</a>
        <a href="datasets.html">Datasets</a>
        <a href="scoring.html">Scoring</a>
        <a href="docs.html">Docs</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero" aria-labelledby="leaderboard-title">
      <h1 id="leaderboard-title">Leaderboard</h1>
      <p>Official benchmark results. Scores are updated when participants run the CLI evaluator and submit JSON outputs.
      </p>
      <p class="table-hint">LCB Score = 30% SC + 45% DQ + 25% BF</p>
    </section>

    <section aria-labelledby="current-results">
      <h2 class="section-title" id="current-results">Current Results</h2>
      <div id="leaderboard-state" class="state" role="status">Loading leaderboard...</div>
      <div class="leaderboard-placeholder" id="leaderboard-empty" hidden>No submissions available yet.</div>
      <div class="state" id="leaderboard-error" hidden>
        Unable to load leaderboard. Ensure <code>results/leaderboard.json</code> exists or re-run
        <code>legacycodebench evaluate</code>.
      </div>

      <div class="table-wrapper" style="overflow-x:auto;margin-top:1rem;">
        <table aria-describedby="leaderboard-title" id="leaderboard-table" hidden>
          <thead>
            <tr>
              <th scope="col">Rank</th>
              <th scope="col">Model</th>
              <th scope="col">LCB Score</th>
              <th scope="col">SC (%)</th>
              <th scope="col">DQ (%)</th>
              <th scope="col">BF (%)</th>
              <th scope="col">Tasks</th>
              <th scope="col">T1</th>
              <th scope="col">T4</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body"></tbody>
        </table>
      </div>
    </section>

    <section aria-labelledby="submission-notes">
      <h2 class="section-title" id="submission-notes">Submission Workflow</h2>
      <ol class="list-muted">
        <li>Run models via CLI (<code>legacycodebench run-ai --model gpt-4o</code>).</li>
        <li>Generate JSON results (<code>legacycodebench evaluate</code>).</li>
        <li>Open a pull request adding your result JSON to the repository.</li>
        <li>Maintainers review and update this leaderboard.</li>
      </ol>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:space-between;">
      <span>LegacyCodeBench &middot; Kalmantic AI Labs</span>
      <span>GitHub &middot; <a href="https://github.com/kalmantic/legacycodebench" target="_blank"
          rel="noreferrer">kalmantic/legacycodebench</a></span>
      <span>Contact &middot; <a href="mailto:nikita@kalmantic.com">nikita@kalmantic.com</a></span>
    </div>
  </footer>

  <script>
    (function initLeaderboard() {
      const stateEl = document.getElementById('leaderboard-state');
      const table = document.getElementById('leaderboard-table');
      const body = document.getElementById('leaderboard-body');
      const empty = document.getElementById('leaderboard-empty');
      const error = document.getElementById('leaderboard-error');

      // Try multiple paths for the leaderboard file
      const paths = [
        'leaderboard.json',
        '../results/leaderboard.json',
        'results/leaderboard.json',
      ];

      async function tryLoadLeaderboard() {
        for (const path of paths) {
          try {
            const url = new URL(path, window.location.href);
            url.searchParams.set('t', Date.now());
            const res = await fetch(url);
            if (res.ok) {
              console.log('Loaded leaderboard from:', path);
              return await res.json();
            }
          } catch (e) {
            // Try next path
          }
        }
        return null;
      }

      tryLoadLeaderboard()
        .then(data => {
          stateEl.hidden = true;

          if (!data) {
            error.hidden = false;
            return;
          }

          const entries = Array.isArray(data.leaderboard) ? data.leaderboard : [];
          console.log('Leaderboard entries', entries);

          if (entries.length === 0) {
            empty.hidden = false;
            return;
          }

          // Clear any previous rows (helps during hot reloads)
          body.innerHTML = '';

          entries.forEach((entry, idx) => {
            console.log('render row', idx, entry);
            const row = document.createElement('tr');
            // V2.3.1 format: avg_lcb_score, avg_sc, avg_bf, avg_sq (DQ)
            const lcbScore = (entry.avg_lcb_score ?? 0) * 100;
            const sc = (entry.avg_sc ?? 0) * 100;
            const bf = (entry.avg_bf ?? 0) * 100;
            const dq = (entry.avg_sq ?? 0) * 100;  // DQ stored as sq
            const t1 = entry.by_tier?.T1?.avg_score ? entry.by_tier.T1.avg_score * 100 : 0;
            const t4 = entry.by_tier?.T4?.avg_score ? entry.by_tier.T4.avg_score * 100 : 0;

            // Format model name
            const modelName = entry.model || entry.submitter || '';
            const displayName = entry.submitter && entry.model && entry.submitter !== entry.model
              ? entry.submitter + ' / ' + entry.model
              : modelName;

            row.innerHTML =
              '<td>' + (entry.rank ?? idx + 1) + '</td>' +
              '<td><strong>' + displayName + '</strong></td>' +
              '<td><strong>' + lcbScore.toFixed(1) + '%</strong></td>' +
              '<td>' + sc.toFixed(1) + '%</td>' +
              '<td>' + dq.toFixed(1) + '%</td>' +
              '<td>' + bf.toFixed(1) + '%</td>' +
              '<td>' + (entry.tasks_total ?? 0) + '</td>' +
              '<td>' + t1.toFixed(0) + '%</td>' +
              '<td>' + t4.toFixed(0) + '%</td>';
            body.appendChild(row);
          });

          table.hidden = false;
        })
        .catch((err) => {
          console.error('Failed to load leaderboard:', err);
          stateEl.hidden = true;
          error.hidden = false;
        });
    })();
  </script>
</body>

</html>